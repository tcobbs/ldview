# Maintainer: Peter Bartfai <pbartfai@stardust.hu>
pkgname=ldview
#pkgver=4.4.1_beta2
pkgver=4.6.1
pkgrel=1
pkgdesc="A real-time 3D viewer for displaying LDraw models"
url="http://github.com/tcobbs/ldview"
arch="all"
license="GPL"
makedepends="qt6-qtbase-dev qt6-qttools qt5-qtbase-dev qt5-qttools-dev glu-dev libjpeg-turbo-dev make minizip-dev tinyxml2-dev mesa-dev"
#source="ldview-git.tar.gz"
subpackages="$pkgname-qt5 $pkgname-osmesa"
options="!check"

build() {
  test -d ${srcdir}/ldview-git/QT && cd ${srcdir}/ldview-git/QT
  lrelease-qt5 LDView.pro
  qmake6
  make "TESTING=-D_POSIX_C_SOURCE" ${MAKEFLAGS}
  cp -f LDView LDView.qt6
  qmake-qt5
  make clean
  make "TESTING=-D_POSIX_C_SOURCE" ${MAKEFLAGS}
  cp -f LDView LDView.qt5
  cd ../OSMesa
  make TESTING=-D_POSIX_C_SOURCE ${MAKEFLAGS}
}
 
package() {
  test -d ${srcdir}/ldview-git/QT && cd ${srcdir}/ldview-git/QT
  make INSTALL_ROOT="${pkgdir}" install
  cp -f LDView.qt6 ${pkgdir}/usr/bin/LDView
  cp -f LDView.qt5 ${pkgdir}/usr/bin/LDView.qt5
  cd ../OSMesa
  make PREFIX="${pkgdir}" install
}

qt5() {
  cp -fr "${pkgdir}" "${subpkgdir}"
  mv -f "${pkgdir}"/usr/bin/LDView.qt5 "${subpkgdir}"/usr/bin/LDView
  test -f "${subpkgdir}"/usr/bin/ldview && rm -f "${subpkgdir}"/usr/bin/ldview
  test -f "${subpkgdir}"/usr/share/man/man1/ldview.1.gz && rm -f "${subpkgdir}"/usr/share/man/man1/ldview.1.gz
}

osmesa() {
  mkdir -p "${subpkgdir}"/usr/bin "${subpkgdir}"/usr/share/man/man1 "${subpkgdir}"/usr/share/ldview
  mv "${pkgdir}"/usr/bin/ldview "${subpkgdir}"/usr/bin
  mv "${pkgdir}"/usr/share/man/man1/ldview.1.gz "${subpkgdir}"/usr/share/man/man1/
}
