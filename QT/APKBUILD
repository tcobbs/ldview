# Maintainer: Peter Bartfai <pbartfai@stardust.hu>
pkgname=ldview
#pkgver=4.4.1_beta2
pkgver=4.6.1
pkgrel=1
pkgdesc="A real-time 3D viewer for displaying LDraw models"
url="http://github.com/tcobbs/ldview"
arch="all"
license="GPL"
#Qt5.x
depends="libpng libjpeg-turbo minizip tinyxml mesa-egl"
makedepends="qt5-qtbase-dev qt5-qttools-dev glu-dev libjpeg-turbo-dev make cmake extra-cmake-modules minizip-dev tinyxml-dev"
#source="ldview-git.tar.gz"
subpackages="$pkgname-osmesa"
options="!check"

build() {
  if test "$CARCH" == x86_64; then
    PLATFORM=linux-g++-64
  else
    PLATFORM=linux-g++-32
  fi
  if   [ -x /usr/bin/qmake     ] ; then qmake      -spec $PLATFORM ;
  elif [ -x /usr/bin/qmake-qt5 ] ; then qmake-qt5 -spec $PLATFORM  ; fi
  if   [ -x /usr/bin/lrelease     ] ; then lrelease     LDView.pro ;
  elif [ -x /usr/bin/lrelease-qt5 ] ; then lrelease-qt5 LDView.pro ; fi
  make "TESTING=-I ../3rdParty/gl2ps -D_POSIX_C_SOURCE" ${MAKEFLAGS}
  cd kde5
  if [ -d build ]; then rm -rf build ; fi
  mkdir -p build
  cd build
  if cmake -DCMAKE_INSTALL_PREFIX=`kf5-config --prefix` .. ; then
    make ${MAKEFLAGS}
  fi
  cd ../../../OSMesa
  make TESTING=-D_POSIX_C_SOURCE ${MAKEFLAGS}
}
 
package() {
  test -d ${srcdir}/ldview-git/QT && cd ${srcdir}/ldview-git/QT
  make INSTALL_ROOT="${pkgdir}" install
  cd ../OSMesa
  make PREFIX="${pkgdir}" install
#  cd kde5/build
#  make DESTDIR="${pkgdir}" install
}

osmesa() {
  mkdir -p "${subpkgdir}"/usr/bin "${subpkgdir}"/usr/share/man/man1 "${subpkgdir}"/usr/share/ldview
  mv "${pkgdir}"/usr/bin/ldview "${subpkgdir}"/usr/bin
  mv "${pkgdir}"/usr/share/man/man1/ldview.1.gz "${subpkgdir}"/usr/share/man/man1/
}
